
# Reseteo del entorno
rm(list=ls())

# Directorio con los datos
path <- "C:/Users/victo/OneDrive/Escritorio/UNIR/TFM/Scripts TFM/Christ A (2019)"
setwd(path)

# Carga de librerías
library(dplyr)   # Manipulacion de datos
library(tidyr)
library(DataExplorer)  # Para plot_intro
library(stats)   # Para dist, PCA, kmeans, hclust
library(factoextra)   # Para fviz_eig, fviz_cos2, fviz_contrib, fviz_clust, fviz_nbclust, fviz_dend
library(Rtsne)   # Para t-SNE
library(FNN)   # Para get.knnx
library(caret)   # Para createDataPartition, train
library(rattle) # DT plot
library(ggplot2)   # Para representación gráfica
library(kableExtra)   # Para tablas
library(gt)   # Para tablas



#### ---- LECTURA DE DATOS ---- ####

# Base de datos
data <- read.csv('GSE106789_GeneLevel_Raw_data.csv', header=TRUE, sep=",")

# Metadatos y simbolos de genes
metadata <- read.csv('GSE106789_filtered_metadata.csv', sep = ",")   
metadata <- metadata %>% 
  mutate(diet = recode(diet,
                      "chow-diet" = "CD",
                      "HFD" = "HFD",
                      "chow-diet>Western-diet" = "CD>HFD"))
gene_symbols <- data[,1:2]
data <- data %>% select(-c(1, 2))   # Eliminamos codigos de genes


# Transponemos el dataset para tener muestras en filas y genes en columnas
data <- t(data)
data <- as_tibble(data)   # Convierte matriz otra vez a tibble

# Incorporamos nombres de filas (muestras) y columnas (genes)
rownames(data) <- metadata[["X"]]
colnames(data) <- gene_symbols[["gene_symbol"]]



#### ---- DEPURACION DE DATOS ----

# Eliminamos columnas con nombres repetidos (genes que se han representado varias veces)
# (todas las apariciones, dado que no sabemos cual es la medicion valida)
data <- data[, !names(data) %in% names(data)[duplicated(names(data))]]

# Eliminamos columnas con todo ceros
sumas <- colSums(data)    # Suma todos los valores de cada columna
sumaszero <- sumas == 0   # Si la suma es 0, se apunta el nombre de la columna como TRUE
data <- data[, !sumaszero]   # Eliminamos las columnas con todo ceros

# Guardamos nombres de los genes conservados
genes_conservados <- colnames(data)

# Incluimos columnas de condiciones
data["stimulation"] <- metadata["stimulation"]
data["diet"] <- metadata["diet"]
data["batch"] <- metadata["batch"]
data <- data %>% 
  relocate("stimulation", .before = everything()) %>%
  relocate("diet", .before = everything()) %>%
  relocate("batch", .before = everything())


